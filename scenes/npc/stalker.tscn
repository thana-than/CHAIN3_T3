[gd_scene load_steps=15 format=3 uid="uid://83xtbr10b03f"]

[ext_resource type="PackedScene" uid="uid://hv3q4g1hg5ha" path="res://assets/models/npc/npc_001.fbx" id="1_ucw7x"]
[ext_resource type="AnimationLibrary" uid="uid://cdlr0yiu6simk" path="res://assets/animations/All_Animations.tres" id="2_u34x5"]
[ext_resource type="Script" uid="uid://glr2uml18crh" path="res://scripts/animation/animation_sequencer.gd" id="3_sgi4o"]
[ext_resource type="Script" uid="uid://bat76x8xqttar" path="res://scripts/dialogue/dialogue_interactable.gd" id="4_xkdqm"]
[ext_resource type="PackedScene" uid="uid://d2nw21rtn1pq6" path="res://assets/dialogue/styles/gothic_silent_hill/Balloon.tscn" id="5_kfl2c"]
[ext_resource type="Resource" uid="uid://duvncsmuvdoj7" path="res://assets/dialogue/dialogue/ticket_inspector.dialogue" id="6_ucw7x"]
[ext_resource type="Script" uid="uid://c1eo4j34dxno3" path="res://scripts/dialogue/dialogue_settings.gd" id="7_nklu1"]
[ext_resource type="Script" uid="uid://d4mre44gaciao" path="res://scripts/dialogue/dialogue_player_settings.gd" id="8_6mfii"]
[ext_resource type="Script" path="res://scripts/animation/head_look_at_controller.gd" id="9_7kdbt"]

[sub_resource type="Shader" id="Shader_kaq2p"]
code = "shader_type spatial;
render_mode blend_mix, unshaded, cull_back;

uniform sampler2D screen_texture : hint_screen_texture, repeat_disable, filter_nearest;

// Mosaic controls
uniform float mosaic_pixel_size = 8.0;

void fragment() {	
	// setup the mask as something 
	//float mask = 1.0 - pow(clamp(base_col.a, 0.0, 1.0), mask_sharpness);
	
	vec2 suv = SCREEN_UV;
	
	// get pixels and quantize 
	vec2 vp = vec2(VIEWPORT_SIZE); // viewport resolution
	vec2 px_uv = suv * vp;
	vec2 q = floor(px_uv / mosaic_pixel_size) * mosaic_pixel_size + (mosaic_pixel_size * 0.5);
	vec2 mosaic_uv = q / vp;
	
	vec3 sampled_rgb = texture(screen_texture, mosaic_uv).rgb;
	
	EMISSION = sampled_rgb;
	ALBEDO = sampled_rgb;
	ALPHA = 1.0;
}"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_ucw7x"]
render_priority = 0
shader = SubResource("Shader_kaq2p")
shader_parameter/mosaic_pixel_size = 5.0

[sub_resource type="Resource" id="Resource_u34x5"]
script = ExtResource("7_nklu1")
balloon_scene = ExtResource("5_kfl2c")
dialogue_resource = ExtResource("6_ucw7x")
dialogue_start = "start"
metadata/_custom_type_script = "uid://c1eo4j34dxno3"

[sub_resource type="Resource" id="Resource_ucw7x"]
script = ExtResource("8_6mfii")
is_repeatable = true
next_after_seconds = 10.0
metadata/_custom_type_script = "uid://d4mre44gaciao"

[sub_resource type="CapsuleShape3D" id="CapsuleShape3D_ap2pf"]
radius = 0.34088
height = 1.56803

[node name="npc" instance=ExtResource("1_ucw7x")]

[node name="Armature" parent="." index="0"]
transform = Transform3D(0.6, 0, 0, 0, 0.6, 4.52987e-08, 0, -4.52987e-08, 0.6, 0, 0, 0)

[node name="Skeleton3D" parent="Armature" index="0"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1.58744e-08, -0.210263)
bones/0/position = Vector3(-0.000770688, 0.956057, -0.0878627)
bones/0/rotation = Quaternion(0.132113, -0.0192109, 0.00153401, 0.991047)
bones/1/rotation = Quaternion(0.0445983, 0.0101101, -0.00664499, 0.998932)
bones/2/rotation = Quaternion(0.0772452, 0.0101486, 0.000401528, 0.99696)
bones/3/rotation = Quaternion(0.0773289, 0.00951726, 0.000129421, 0.99696)
bones/4/rotation = Quaternion(-0.0444039, 0.00569075, -0.00239628, 0.998995)
bones/5/rotation = Quaternion(-0.104659, 0.00553563, -0.00273562, 0.994489)
bones/8/rotation = Quaternion(0.58715, 0.411665, -0.581255, 0.384617)
bones/9/rotation = Quaternion(0.379362, -0.00101497, 0.269128, 0.885242)
bones/10/rotation = Quaternion(0.0967045, -0.0016093, 0.810862, 0.57719)
bones/11/rotation = Quaternion(-0.086403, 0.0690771, -0.172773, 0.97873)
bones/12/rotation = Quaternion(0.142019, 0.0600732, 0.0560012, 0.986451)
bones/13/rotation = Quaternion(0.0491751, -0.0201575, -0.089635, 0.994556)
bones/14/rotation = Quaternion(-0.00076039, -0.00729144, 0.0359219, 0.999328)
bones/17/rotation = Quaternion(0.111342, 0.00421157, 0.0255544, 0.993445)
bones/18/rotation = Quaternion(0.0944226, -8.07466e-05, -0.0191964, 0.995347)
bones/19/rotation = Quaternion(0.0472657, 9.11376e-05, -0.00921208, 0.99884)
bones/22/rotation = Quaternion(0.517321, -0.468513, 0.569364, 0.434395)
bones/23/rotation = Quaternion(0.432064, -0.0221158, -0.229674, 0.871826)
bones/24/rotation = Quaternion(0.0956292, 0.00158052, -0.82982, 0.549775)
bones/25/rotation = Quaternion(-0.061768, -0.0643593, 0.208855, 0.97387)
bones/26/rotation = Quaternion(0.196625, -0.0692362, -0.0703078, 0.975501)
bones/27/rotation = Quaternion(0.0390418, -0.00818921, 0.137997, 0.989629)
bones/28/rotation = Quaternion(-0.00719508, -0.00290865, -0.0370295, 0.999284)
bones/31/rotation = Quaternion(0.121376, -0.00404547, -0.0210578, 0.992375)
bones/32/rotation = Quaternion(0.228386, 0.000141225, 0.0351493, 0.972936)
bones/33/rotation = Quaternion(0.114971, -0.000256547, 0.0160804, 0.993239)
bones/36/rotation = Quaternion(0.116024, 0.340766, 0.931639, -0.0496534)
bones/37/rotation = Quaternion(-0.258613, -0.0830212, 0.0167172, 0.962262)
bones/38/rotation = Quaternion(0.487899, -0.0621349, 0.0484015, 0.869339)
bones/39/rotation = Quaternion(0.290129, -0.0565436, 0.0171548, 0.955162)
bones/42/rotation = Quaternion(-0.21302, 0.34578, 0.91379, -0.00679609)
bones/43/rotation = Quaternion(-0.252615, 0.0721965, -0.0855488, 0.96107)
bones/44/rotation = Quaternion(0.499857, 0.0387237, 0.00111472, 0.865241)
bones/45/rotation = Quaternion(0.289491, 0.0574358, -0.0173331, 0.955299)

[node name="BoneAttachment3D" type="BoneAttachment3D" parent="Armature/Skeleton3D" index="1"]
transform = Transform3D(0.998972, 0.0020244, 0.0452735, 0.0142799, 0.93405, -0.356857, -0.0430101, 0.357137, 0.933061, 0.000536616, 1.8949, 0.425138)
bone_name = "mixamorig1_Head"
bone_idx = 5

[node name="CensoredBlur" type="CSGBox3D" parent="Armature/Skeleton3D/BoneAttachment3D" index="0"]
transform = Transform3D(1.00003, -5.04777e-07, 2.76603e-07, -2.79397e-07, 1, -1.72853e-06, -1.81608e-07, 2.98023e-08, 1, 0.0135806, 0.151993, 0.0100708)
size = Vector3(0.343689, 0.576324, 0.439331)
material = SubResource("ShaderMaterial_ucw7x")

[node name="AnimationPlayer" type="AnimationPlayer" parent="Armature" index="1"]
libraries = {
&"All_Animations": ExtResource("2_u34x5")
}
script = ExtResource("3_sgi4o")
play_on_ready = true
loop_sequence = true
sequence = Array[String](["All_Animations/OldManIdle"])

[node name="DialogueInteractable" type="Area3D" parent="." index="1"]
script = ExtResource("4_xkdqm")
dialogue_settings = SubResource("Resource_u34x5")
player_settings = SubResource("Resource_ucw7x")
metadata/_custom_type_script = "uid://bat76x8xqttar"

[node name="CollisionShape3D" type="CollisionShape3D" parent="DialogueInteractable" index="0"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0.0241189, 0.552854, -0.0852549)
shape = SubResource("CapsuleShape3D_ap2pf")

[node name="HeadLookAtController" type="Node3D" parent="." index="2" node_paths=PackedStringArray("skeleton", "interactable")]
script = ExtResource("9_7kdbt")
skeleton = NodePath("../Armature/Skeleton3D")
interactable = NodePath("../DialogueInteractable")
follow_seconds = 10.0
